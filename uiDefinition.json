{
    "$schema": "<relative path to createFormUI.schema.json>",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "CrowdStrike Falcon Cloud Security Posture Management",
            "isWizard": true,
            "steps": [
                {
                    "name": "basics",
                    "label": "Basics",
                    "elements": [
                        {
                            "name": "resourceScope",
                            "type": "Microsoft.Common.ResourceScope",
                            "location": {
                                "resourceTypes": [
                                    "microsoft.resources/resourcegroups"
                                ]
                            }
                        }
                    ]
                },
                {
                    "name": "iom",
                    "label": "Enable IOM (Indiactors of Misconfiguration)",
                    "elements": [
                        {
                            "name": "iomDeployment",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "enable",
                                    "type": "Microsoft.Common.CheckBox",
                                    "label": "Enable Indicators of Misconfiguration",
                                    "defaultValue": false,
                                    "visible": true
                                }
                            ]
                        },
                        {
                            "name": "identity",
                            "type": "Microsoft.Common.Section",
                            "visible": "[steps('iom').iomDeployment.enable]",
                            "elements" : [
                                {
                                    "name": "sp",
                                    "type": "Microsoft.Common.ServicePrincipalSelector",
                                    "visible": "[equals(steps('iom').iomDeployment.enable, true)]",
                                    "label": {
                                        "password": "Password",
                                        "authenticationType": "Authentication Type",
                                        "sectionHeader": "Service Principal"
                                    },
                                    "toolTip": {
                                        "password": "Password",
                                        "authenticationType": "Authentication Type"
                                    },
                                    "defaultValue": {
                                        "principalId": "<default guid>",
                                        "name": "<default name>"
                                    },
                                    "options": {
                                        "hideCertificate": true
                                    }
                                },
                                {
                                    "name": "managedIdentity",
                                    "type": "Microsoft.Solutions.ResourceSelector",
                                    "label": "Select user assigned identity",
                                    "visible": "[equals(steps('iom').iomDeployment.enable, true)]",
                                    "resourceType": "Microsoft.ManagedIdentity/userAssignedIdentities",
                                    "options": {
                                        "filter": {
                                            "subscription": "onBasics",
                                            "location": "onBasics"
                                        }
                                    }
                                },
                                {
                                    "name": "exemption",
                                    "type": "Microsoft.Common.EditableGrid",
                                    "ariaLabel": "Enter the policy IDs to exempt to during the deployment of Falcon Cloud Security Posture Management",
                                    "defaultValue": [],
                                    "visible": "[equals(steps('iom').iomDeployment.enable, true)]",
                                    "label": "Policy Exemptions",
                                    "constraints": {
                                        "width": "Full",
                                        "rows": {
                                            "count": {
                                                "min": 0,
                                                "max": 100
                                            }
                                        },
                                        "columns": [
                                            {
                                                "id": "id",
                                                "header": "Policy Assignment Resource IDs for Exemption",
                                                "toolTip": "Enter the policy assignment resource IDs to exempt during the deployment of Falcon Cloud Security Posture Management deployment",
                                                "width": "1fr",
                                                "element": {
                                                    "type": "Microsoft.Common.TextBox",
                                                    "placeholder": "",
                                                    "constraints": {
                                                        "required": true,
                                                        "validations": []
                                                    }
                                                }
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "ioa",
                    "label": "Enable IOAs (Indiactors of Attack)",
                    "elements": [
                        {
                            "name": "ioaDeployment",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "enable",
                                    "type": "Microsoft.Common.CheckBox",
                                    "label": "Enable Indicators of Attack",
                                    "defaultValue": false,
                                    "visible": true
                                },
                                {
                                    "name": "enableAppInsights",
                                    "type": "Microsoft.Common.CheckBox",
                                    "label": "Enable Application Insights",
                                    "constraints": {
                                        "required": false
                                    },
                                    "visible": "[steps('ioa').ioaDeployment.enable]"

                                },
                                {
                                    "name": "deployActivityLogDiagnosticSettings",
                                    "type": "Microsoft.Common.CheckBox",
                                    "label": "Deploy Activity Log Diagnostic Settings (current Subscription)",
                                    "constraints": {
                                        "required": false
                                    },
                                    "visible": "[steps('ioa').ioaDeployment.enable]"
                                },
                                {
                                    "name": "deployEntraLogDiagnosticSettings",
                                    "type": "Microsoft.Common.CheckBox",
                                    "label": "Deploy Entra ID Log Diagnostic Settings",
                                    "constraints": {
                                        "required": false
                                    },
                                    "visible": "[steps('ioa').ioaDeployment.enable]"
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "falconCloudSecurity",
                    "label": "Falcon Cloud Security Information",
                    "elements": [
                        {
                            "name": "credentials",
                            "label": "Credentials",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "falconClientId",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Falcon Client Id",
                                    "defaultValue": "",
                                    "toolTip": "Use only allowed characters",
                                    "placeholder": "",
                                    "multiLine": false,
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[0-9a-fA-F]{32}$",
                                        "validationMessage": "Falcon Client ID is invalid. Please re-enter."
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "falconClientSecret",
                                    "type": "Microsoft.Common.PasswordBox",
                                    "label": {
                                        "password": "Falcon Client Secret"
                                    },
                                    "toolTip": "",
                                    "constraints": {
                                        "required": true,
                                        "regex": "\\w{40}$",
                                        "validations": [
                                            {}
                                        ]
                                    },
                                    "options": {
                                        "hideConfirmation": true
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "falconCID",
                                    "type": "Microsoft.Common.PasswordBox",
                                    "label": {
                                        "password": "Falcon CID"
                                    },
                                    "toolTip": "",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[0-9a-fA-F]{32}$",
                                        "validationMessage": "Falcon CID is invalid. Please re-enter."
                                    },
                                    "options": {
                                        "hideConfirmation": true
                                    },
                                    "visible": "[steps('ioa').ioaDeployment.enable]"
                                },
                                {
                                    "name": "region",
                                    "type": "Microsoft.Common.DropDown",
                                    "label": "Falcon Cloud Region",
                                    "placeholder": "",
                                    "defaultValue": ["Value two"],
                                    "toolTip": "",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": false,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": false,
                                    "defaultDescription": "A value for selection",
                                    "constraints": {
                                      "allowedValues": [
                                        {
                                          "label": "US-1",
                                          "description": "US-1 Region",
                                          "value": "US-1"
                                        },
                                        {
                                          "label": "US-2",
                                          "description": "US-2 Region",
                                          "value": "US-2"
                                        },
                                        {
                                        "label": "EU-1",
                                        "description": "EU-1 Region",
                                        "value": "EU-1"
                                        }
                                      ],
                                      "required": true
                                    },
                                    "visible": true
                                  }
                            ]
                        }
                    ]
                },
                {
                    "name": "tags",
                    "label": "Tags",
                    "elements": [
                        {
                            "name": "tagsByResource",
                            "type": "Microsoft.Common.TagsByResource",
                            "resources": [
                                "Microsoft.Storage/storageAccounts",
                                "Microsoft.Compute/virtualMachines",
                                "Microsoft.Network/virtualNetworks",
                                "Microsoft.EventHub/namespaces",
                                "Microsoft.Web/sites",
                                "Microsoft.Network/privateEndpoints"
                            ]
                        }
                    ]
                }
            ]
        },
        "outputs": {
            "kind": "Subscription",
            "subscriptionId": "[steps('basics').resourceScope.subscription.id]",
            "location": "[steps('basics').resourceScope.location.name]",
            "parameters": {
                "appRegistrationAppId": "[if(equals(steps('iom').iomDeployment.enable, true), steps('iom').identity.sp.appId, '')]",
                "deployActivityLogDiagnosticSettings": "[if(equals(steps('ioa').ioaDeployment.enable, true), steps('ioa').ioaDeployment.deployActivityLogDiagnosticSettings, false)]",
                "deployEntraLogDiagnosticSettings": "[if(equals(steps('ioa').ioaDeployment.enable, true), steps('ioa').ioaDeployment.deployEntraLogDiagnosticSettings, false)]",
                "deployIOA": "[steps('ioa').ioaDeployment.enable]",
                "deployIOM": "[steps('iom').iomDeployment.enable]",
                "enableAppInsights": "[if(equals(steps('ioa').ioaDeployment.enable, true), steps('ioa').ioaDeployment.enableAppInsights, false)]",  
                "exemptPolicyAssignmentIds": "[if(equals(steps('iom').iomDeployment.enable, true), map(steps('iom').identity.exemption, (item) => item.id), '')]",
                "falconCID": "[if(equals(steps('ioa').ioaDeployment.enable, true), steps('falconCloudSecurity').credentials.falconCID,'')]",
                "falconClientId": "[steps('falconCloudSecurity').credentials.falconClientId]",
                "falconClientSecret": "[steps('falconCloudSecurity').credentials.falconClientSecret]",
                "falconCloudRegion": "[if(equals(steps('ioa').ioaDeployment.enable, true), steps('falconCloudSecurity').credentials.region,'US-1')]",
                "tagsByResource": "[steps('tags').tagsByResource]",
                "uamiName": "[if(equals(steps('iom').iomDeployment.enable, true), steps('iom').identity.managedIdentity.name, '')]",
                "uamiResourceId": "[[if(equals(steps('iom').iomDeployment.enable, true), steps('iom').identity.managedIdentity.id, '')]"
            }
        }
    }
}